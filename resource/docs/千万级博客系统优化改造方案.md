# åƒä¸‡çº§åšå®¢ç³»ç»Ÿä¼˜åŒ–æ”¹é€ æ–¹æ¡ˆ

## ğŸ“‹ ç›®å½•

- [1. ç³»ç»Ÿç°çŠ¶åˆ†æ](#1-ç³»ç»Ÿç°çŠ¶åˆ†æ)
- [2. æ€§èƒ½ç“¶é¢ˆè¯†åˆ«](#2-æ€§èƒ½ç“¶é¢ˆè¯†åˆ«)
- [3. æ•°æ®åº“å±‚ä¼˜åŒ–](#3-æ•°æ®åº“å±‚ä¼˜åŒ–)
- [4. ç¼“å­˜æ¶æ„ä¼˜åŒ–](#4-ç¼“å­˜æ¶æ„ä¼˜åŒ–)
- [5. æ¶ˆæ¯é˜Ÿåˆ—åº”ç”¨](#5-æ¶ˆæ¯é˜Ÿåˆ—åº”ç”¨)
- [6. æœç´¢æœåŠ¡ä¼˜åŒ–](#6-æœç´¢æœåŠ¡ä¼˜åŒ–)
- [7. æœåŠ¡æ²»ç†ä¼˜åŒ–](#7-æœåŠ¡æ²»ç†ä¼˜åŒ–)
- [8. æ¥å£æ€§èƒ½ä¼˜åŒ–](#8-æ¥å£æ€§èƒ½ä¼˜åŒ–)
- [9. æ–‡ä»¶å­˜å‚¨ä¼˜åŒ–](#9-æ–‡ä»¶å­˜å‚¨ä¼˜åŒ–)
- [10. ç›‘æ§ä¸è¿ç»´](#10-ç›‘æ§ä¸è¿ç»´)
- [11. å®‰å…¨ä¼˜åŒ–](#11-å®‰å…¨ä¼˜åŒ–)
- [12. å®æ–½è·¯çº¿å›¾](#12-å®æ–½è·¯çº¿å›¾)

---

## 1. ç³»ç»Ÿç°çŠ¶åˆ†æ

### 1.1 å½“å‰æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Nginx / CDN                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              Spring Cloud Gateway (80)                  â”‚
â”‚         - ç»Ÿä¸€ç½‘å…³  - è·¯ç”±è½¬å‘  - é‰´æƒ                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚blog-authâ”‚blog-systemâ”‚blog-act â”‚blog-clientâ”‚blog-fileâ”‚
â”‚  8001   â”‚   8080   â”‚  8025   â”‚   8002   â”‚   8030  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚               Nacos (æœåŠ¡æ³¨å†Œ/é…ç½®ä¸­å¿ƒ)                  â”‚
â”‚              Sentinel (é™æµç†”æ–­)                         â”‚
â”‚              RocketMQ (æ¶ˆæ¯é˜Ÿåˆ—)                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              MySQL + Redis (å•æœº/ç®€å•é›†ç¾¤)               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 1.2 æŠ€æœ¯æ ˆæ¸…å•

| ç±»åˆ« | æŠ€æœ¯ | ç‰ˆæœ¬ |
|------|------|------|
| æ ¸å¿ƒæ¡†æ¶ | Spring Boot | 3.2.12 |
| å¾®æœåŠ¡æ¡†æ¶ | Spring Cloud | 2023.0.5 |
| æœåŠ¡æ³¨å†Œ | Nacos | 2023.0.1.0 |
| ç½‘å…³ | Spring Cloud Gateway | - |
| å®¹é”™ | Sentinel | 2023.0.3.2 |
| æ•°æ®åº“ | MySQL | 5.x |
| ORM | MyBatis-Plus | 3.5.7 |
| ç¼“å­˜ | Redis + Redisson | - |
| æ¶ˆæ¯é˜Ÿåˆ— | RocketMQ | - |
| APIæ–‡æ¡£ | Knife4j | - |

### 1.3 æ ¸å¿ƒä¸šåŠ¡è¡¨

| è¡¨å | è¯´æ˜ | æ•°æ®é‡é¢„ä¼° |
|------|------|-----------|
| sys_article | æ–‡ç« è¡¨ | åƒä¸‡çº§ |
| sys_comment | è¯„è®ºè¡¨ | äº¿çº§ |
| sys_user | ç”¨æˆ·è¡¨ | ç™¾ä¸‡çº§ |
| sys_tag | æ ‡ç­¾è¡¨ | ä¸‡çº§ |
| sys_category | åˆ†ç±»è¡¨ | åƒçº§ |
| sys_moment | åŠ¨æ€è¡¨ | ç™¾ä¸‡çº§ |

### 1.4 ç°æœ‰ä¼˜åŠ¿

âœ… å¾®æœåŠ¡æ¶æ„ï¼Œå…·å¤‡è‰¯å¥½çš„æ‰©å±•æ€§
âœ… å·²é›†æˆNacosæœåŠ¡æ²»ç†
âœ… å·²é›†æˆSentinelé™æµç†”æ–­
âœ… å·²æœ‰Redisç¼“å­˜åŸºç¡€
âœ… å·²æœ‰RocketMQæ¶ˆæ¯é˜Ÿåˆ—
âœ… æ”¯æŒåˆ†å¸ƒå¼é”ï¼ˆRedissonï¼‰

---

## 2. æ€§èƒ½ç“¶é¢ˆè¯†åˆ«

### 2.1 é«˜é¢‘è®¿é—®åœºæ™¯åˆ†æ

#### è¯»å¤šå†™å°‘ï¼ˆ8:2ï¼‰
- æ–‡ç« åˆ—è¡¨æŸ¥è¯¢ï¼ˆé¦–é¡µã€åˆ†ç±»ã€æ ‡ç­¾ï¼‰
- æ–‡ç« è¯¦æƒ…é¡µ
- çƒ­é—¨æ–‡ç« æ¨è
- ç”¨æˆ·ä¿¡æ¯æŸ¥è¯¢
- è¯„è®ºåˆ—è¡¨æŸ¥è¯¢

#### å†™å¤šåœºæ™¯
- æ–‡ç« å‘å¸ƒ/ç¼–è¾‘
- è¯„è®ºå‘å¸ƒ
- ç‚¹èµ/å–æ¶ˆç‚¹èµ
- é˜…è¯»é‡æ›´æ–°
- ç”¨æˆ·è¡Œä¸ºè®°å½•

### 2.2 ä¸»è¦æ€§èƒ½ç“¶é¢ˆ

| ç“¶é¢ˆç±»å‹ | å…·ä½“é—®é¢˜ | å½±å“ç¨‹åº¦ | ä¼˜åŒ–ä¼˜å…ˆçº§ |
|---------|---------|---------|-----------|
| **æ•°æ®åº“** | å•è¡¨æ•°æ®é‡è¿‡å¤§ï¼ŒæŸ¥è¯¢æ…¢ | ğŸ”´ ä¸¥é‡ | P0 |
| **æ•°æ®åº“** | å…³è”æŸ¥è¯¢ï¼ˆN+1é—®é¢˜ï¼‰ | ğŸ”´ ä¸¥é‡ | P0 |
| **ç¼“å­˜** | ç¼“å­˜å‘½ä¸­ç‡ä½ï¼Œç©¿é€/å‡»ç©¿/é›ªå´©é£é™© | ğŸ”´ ä¸¥é‡ | P0 |
| **æœç´¢** | æ•°æ®åº“LIKEæ¨¡ç³ŠæŸ¥è¯¢æ€§èƒ½å·® | ğŸ”´ ä¸¥é‡ | P0 |
| **å†™å…¥** | é˜…è¯»é‡ç­‰é«˜é¢‘æ›´æ–°ç›´æ¥å†™åº“ | ğŸŸ¡ ä¸­ç­‰ | P1 |
| **å¹¶å‘** | çƒ­ç‚¹æ–‡ç« æ— é˜²æŠ¤æœºåˆ¶ | ğŸŸ¡ ä¸­ç­‰ | P1 |
| **æ–‡ä»¶** | æœ¬åœ°æ–‡ä»¶å­˜å‚¨æ‰©å±•å›°éš¾ | ğŸŸ¡ ä¸­ç­‰ | P1 |
| **è¿æ¥** | æ•°æ®åº“è¿æ¥æ± æœªä¼˜åŒ– | ğŸŸ¢ è¾ƒè½» | P2 |

---

## 3. æ•°æ®åº“å±‚ä¼˜åŒ–

### 3.1 åˆ†åº“åˆ†è¡¨æ–¹æ¡ˆ

#### 3.1.1 å‚ç›´åˆ†åº“ï¼ˆæŒ‰ä¸šåŠ¡æ¨¡å—ï¼‰

```sql
-- æ‹†åˆ†åæ•°æ®åº“ç»“æ„
blog_user_db          -- ç”¨æˆ·ä¸­å¿ƒåº“
  â”œâ”€â”€ sys_user                    -- ç”¨æˆ·è¡¨
  â”œâ”€â”€ sys_role                    -- è§’è‰²è¡¨
  â”œâ”€â”€ sys_user_role               -- ç”¨æˆ·è§’è‰²å…³è”
  â””â”€â”€ sys_friend                  -- å¥½å‹å…³ç³»

blog_article_db        -- æ–‡ç« åº“
  â”œâ”€â”€ sys_article                -- æ–‡ç« ä¸»è¡¨
  â”œâ”€â”€ sys_article_content        -- æ–‡ç« å†…å®¹ï¼ˆå¤§å­—æ®µåˆ†ç¦»ï¼‰
  â”œâ”€â”€ sys_article_tag            -- æ–‡ç« æ ‡ç­¾å…³è”
  â””â”€â”€ sys_category               -- åˆ†ç±»è¡¨

blog_comment_db        -- è¯„è®ºåº“
  â”œâ”€â”€ sys_comment                -- è¯„è®ºè¡¨
  â””â”€â”€ sys_comment_like           -- è¯„è®ºç‚¹èµ

blog_interaction_db     -- äº’åŠ¨åº“
  â”œâ”€â”€ sys_article_like           -- æ–‡ç« ç‚¹èµ
  â”œâ”€â”€ sys_article_view           -- æ–‡ç« æµè§ˆè®°å½•
  â””â”€â”€ sys_user_follow            -- ç”¨æˆ·å…³æ³¨

blog_content_db         -- å†…å®¹åº“
  â”œâ”€â”€ sys_moment                 -- åŠ¨æ€
  â”œâ”€â”€ sys_album                  -- ç›¸å†Œ
  â””â”€â”€ sys_message                -- æ¶ˆæ¯
```

#### 3.1.2 æ°´å¹³åˆ†è¡¨ï¼ˆå¤§è¡¨æ‹†åˆ†ï¼‰

**æ–‡ç« è¡¨åˆ†è¡¨ç­–ç•¥**

```java
/**
 * æ–‡ç« è¡¨åˆ†è¡¨é…ç½®
 */
public class ArticleShardingStrategy {

    // åˆ†ç‰‡æ•°é‡ï¼š32å¼ è¡¨ï¼ˆå¯æ ¹æ®å®é™…æƒ…å†µè°ƒæ•´ï¼‰
    private static final int TABLE_COUNT = 32;
    private static final int DB_COUNT = 4;

    /**
     * æ–¹æ¡ˆä¸€ï¼šæŒ‰IDå–æ¨¡ï¼ˆæ¨èï¼‰
     * ä¼˜ç‚¹ï¼šæ•°æ®å‡åŒ€åˆ†å¸ƒ
     * ç¼ºç‚¹ï¼šæ‰©å®¹å›°éš¾
     */
    public static String getTableById(Long articleId) {
        int dbIndex = (int) (articleId % DB_COUNT);
        int tableIndex = (int) (articleId % TABLE_COUNT);
        return "blog_article_" + dbIndex + ".sys_article_" + tableIndex;
    }

    /**
     * æ–¹æ¡ˆäºŒï¼šæŒ‰ç”¨æˆ·IDå–æ¨¡ï¼ˆé€‚åˆæŒ‰ç”¨æˆ·æŸ¥è¯¢åœºæ™¯ï¼‰
     * ä¼˜ç‚¹ï¼šåŒä¸€ç”¨æˆ·æ–‡ç« åœ¨åŒä¸€è¡¨ï¼ŒæŸ¥è¯¢ç”¨æˆ·æ–‡ç« å¿«
     */
    public static String getTableByUserId(Long userId) {
        int tableIndex = (int) (userId % 16);
        return "sys_article_user_" + tableIndex;
    }

    /**
     * æ–¹æ¡ˆä¸‰ï¼šæŒ‰æ—¶é—´åˆ†è¡¨ï¼ˆé€‚åˆæ—¶é—´ç»´åº¦æŸ¥è¯¢ï¼‰
     * ä¼˜ç‚¹ï¼šæ•°æ®å½’æ¡£æ–¹ä¾¿ï¼Œå†å²æ•°æ®å¯è¿ç§»
     */
    public static String getTableByTime(LocalDateTime createTime) {
        String yearMonth = createTime.format(DateTimeFormatter.ofPattern("yyyyMM"));
        return "sys_article_" + yearMonth;  // sys_article_202401, sys_article_202402...
    }
}
```

**ShardingSphereé…ç½®ç¤ºä¾‹**

```yaml
# application.yml
spring:
  shardingsphere:
    datasource:
      names: article-db-0,article-db-1,article-db-2,article-db-3
      article-db-0:
        type: com.zaxxer.hikari.HikariDataSource
        driver-class-name: com.mysql.cj.jdbc.Driver
        jdbc-url: jdbc:mysql://192.168.1.100:3306/blog_article_0?useUnicode=true&characterEncoding=utf8&useSSL=false
        username: root
        password: password
      article-db-1:
        jdbc-url: jdbc:mysql://192.168.1.101:3306/blog_article_1
      article-db-2:
        jdbc-url: jdbc:mysql://192.168.1.102:3306/blog_article_2
      article-db-3:
        jdbc-url: jdbc:mysql://192.168.1.103:3306/blog_article_3

    rules:
      sharding:
        tables:
          # æ–‡ç« è¡¨é…ç½®
          sys_article:
            actual-data-nodes: article-db-$->{0..3}.sys_article_$->{0..7}
            table-strategy:
              standard:
                sharding-column: id
                sharding-algorithm-name: article-table-inline
            database-strategy:
              standard:
                sharding-column: id
                sharding-algorithm-name: article-db-inline
            key-generate-strategy:
              column: id
              key-generator-name: snowflake

        sharding-algorithms:
          article-table-inline:
            type: INLINE
            props:
              algorithm-expression: sys_article_$->{id % 8}
          article-db-inline:
            type: INLINE
            props:
              algorithm-expression: article-db-$->{id % 4}

        key-generators:
          snowflake:
            type: SNOWFLAKE
            props:
              worker-id: 1
```

#### 3.1.3 éœ€è¦åˆ†è¡¨çš„æ¸…å•

| è¡¨å | åˆ†è¡¨ç­–ç•¥ | åˆ†è¡¨æ•°é‡ | åˆ†åº“æ•°é‡ |
|------|----------|---------|---------|
| sys_article | æŒ‰IDå–æ¨¡ | 32 | 4 |
| sys_comment | æŒ‰article_idå–æ¨¡ | 64 | 4 |
| sys_article_like | æŒ‰article_idå–æ¨¡ | 64 | 4 |
| sys_article_view | æŒ‰æ—¶é—´ï¼ˆæœˆï¼‰ | åŠ¨æ€ | 2 |
| sys_moment | æŒ‰æ—¶é—´ï¼ˆæœˆï¼‰ | åŠ¨æ€ | 2 |
| sys_message | æŒ‰user_idå–æ¨¡ | 16 | 2 |

### 3.2 è¯»å†™åˆ†ç¦»

```yaml
spring:
  shardingsphere:
    datasource:
      names: master,slave1,slave2
      # ä¸»åº“é…ç½®
      master:
        type: com.zaxxer.hikari.HikariDataSource
        jdbc-url: jdbc:mysql://master-host:3306/blog
        username: root
        password: password
      # ä»åº“é…ç½®
      slave1:
        jdbc-url: jdbc:mysql://slave1-host:3306/blog
      slave2:
        jdbc-url: jdbc:mysql://slave2-host:3306/blog

    rules:
      readwrite-splitting:
        data-sources:
          blog-rw:
            static-strategy:
              write-data-source-name: master
              read-data-source-names: slave1,slave2
            load-balancers:
              round-robin:
                type: ROUND_ROBIN
```

### 3.3 ç´¢å¼•ä¼˜åŒ–æ–¹æ¡ˆ

#### 3.3.1 æ–‡ç« è¡¨ç´¢å¼•

```sql
-- sys_article ç´¢å¼•ä¼˜åŒ–
ALTER TABLE sys_article ADD INDEX idx_user_status_time (user_id, status, create_time DESC);
ALTER TABLE sys_article ADD INDEX idx_category_status (category_id, status, create_time DESC);
ALTER TABLE sys_article ADD INDEX idx_status_recommend (status, is_recommend, create_time DESC);
ALTER TABLE sys_article ADD INDEX idx_status_stick (status, is_stick DESC, create_time DESC);

-- è¦†ç›–ç´¢å¼•ï¼ˆé¿å…å›è¡¨ï¼‰
ALTER TABLE sys_article ADD INDEX idx_cover (id, user_id, title, cover, summary, view_count, create_time);

-- å…¨æ–‡ç´¢å¼•ï¼ˆMySQL 5.7+ï¼‰
ALTER TABLE sys_article ADD FULLTEXT INDEX ft_title_content (title, content) WITH PARSER ngram;

-- è”åˆç´¢å¼•ï¼ˆæœ€å·¦å‰ç¼€åŸåˆ™ï¼‰
-- æŸ¥è¯¢: WHERE status = 1 AND is_recommend = 1 ORDER BY create_time DESC LIMIT 10
-- ç´¢å¼•: (status, is_recommend, create_time)
```

#### 3.3.2 è¯„è®ºè¡¨ç´¢å¼•

```sql
-- sys_comment ç´¢å¼•ä¼˜åŒ–
ALTER TABLE sys_comment ADD INDEX idx_article_time (article_id, create_time DESC);
ALTER TABLE sys_comment ADD INDEX idx_article_parent_time (article_id, parent_id, create_time DESC);
ALTER TABLE sys_comment ADD INDEX idx_user_time (user_id, create_time DESC);

-- è¦†ç›–ç´¢å¼•ä¼˜åŒ–
ALTER TABLE sys_comment ADD INDEX idx_comment_cover (article_id, user_id, content, create_time);
```

#### 3.3.3 ç”¨æˆ·è¡¨ç´¢å¼•

```sql
-- sys_user ç´¢å¼•ä¼˜åŒ–
ALTER TABLE sys_user ADD UNIQUE INDEX uk_username (username);
ALTER TABLE sys_user ADD INDEX idx_status_time (status, create_time DESC);
ALTER TABLE sys_user ADD INDEX idx_mobile (mobile);
ALTER TABLE sys_user ADD INDEX idx_email (email);
```

### 3.4 è¡¨ç»“æ„ä¼˜åŒ–

```sql
-- 1. å¤§å­—æ®µåˆ†ç¦»ï¼ˆæå‡æŸ¥è¯¢æ€§èƒ½ï¼‰
CREATE TABLE sys_article_content (
    article_id BIGINT PRIMARY KEY COMMENT 'æ–‡ç« ID',
    content TEXT COMMENT 'HTMLå†…å®¹',
    content_md LONGTEXT COMMENT 'Markdownå†…å®¹',
    create_time DATETIME COMMENT 'åˆ›å»ºæ—¶é—´',
    FOREIGN KEY (article_id) REFERENCES sys_article(id) ON DELETE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='æ–‡ç« å†…å®¹è¡¨';

-- åˆ é™¤åŸè¡¨ä¸­çš„å¤§å­—æ®µ
ALTER TABLE sys_article DROP COLUMN content;
ALTER TABLE sys_article DROP COLUMN content_md;

-- 2. åˆç†ä½¿ç”¨å†—ä½™å­—æ®µï¼ˆç©ºé—´æ¢æ—¶é—´ï¼‰
ALTER TABLE sys_article ADD COLUMN author_nickname VARCHAR(50) COMMENT 'ä½œè€…æ˜µç§°å†—ä½™';
ALTER TABLE sys_article ADD COLUMN author_avatar VARCHAR(255) COMMENT 'ä½œè€…å¤´åƒå†—ä½™';
ALTER TABLE sys_article ADD COLUMN category_name VARCHAR(50) COMMENT 'åˆ†ç±»åç§°å†—ä½™';

-- 3. å­—æ®µç±»å‹ä¼˜åŒ–
ALTER TABLE sys_article
MODIFY COLUMN title VARCHAR(200) NOT NULL COMMENT 'æ–‡ç« æ ‡é¢˜',
MODIFY COLUMN summary VARCHAR(500) COMMENT 'æ–‡ç« ç®€ä»‹',
MODIFY COLUMN view_count INT UNSIGNED DEFAULT 0 COMMENT 'é˜…è¯»é‡',
MODIFY COLUMN like_count INT UNSIGNED DEFAULT 0 COMMENT 'ç‚¹èµæ•°',
MODIFY COLUMN comment_count INT UNSIGNED DEFAULT 0 COMMENT 'è¯„è®ºæ•°';

-- 4. å­—ç¬¦é›†ç»Ÿä¸€
ALTER TABLE sys_article CONVERT TO CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;

-- 5. æšä¸¾å­—æ®µä¼˜åŒ–
ALTER TABLE sys_article MODIFY COLUMN status TINYINT NOT NULL DEFAULT 0 COMMENT 'çŠ¶æ€ï¼š0-ä¸‹æ¶ï¼Œ1-å‘å¸ƒ';
ALTER TABLE sys_article MODIFY COLUMN is_original TINYINT NOT NULL DEFAULT 1 COMMENT 'æ˜¯å¦åŸåˆ›ï¼š0-è½¬è½½ï¼Œ1-åŸåˆ›';
```

### 3.5 SQLä¼˜åŒ–

#### 3.5.1 åˆ†é¡µä¼˜åŒ–

```java
/**
 * æ·±åˆ†é¡µä¼˜åŒ–å·¥å…·ç±»
 */
public class PageOptimizer {

    /**
     * æ–¹æ¡ˆä¸€ï¼šä½¿ç”¨ä¸Šæ¬¡æœ€å¤§IDï¼ˆé€‚ç”¨äºè¿ç»­åˆ†é¡µï¼‰
     */
    public Page<Article> getPageByLastId(Long lastId, Long pageSize) {
        QueryWrapper<Article> wrapper = new QueryWrapper<>();
        wrapper.gt(lastId != null, "id", lastId)
               .orderByAsc("id")
               .last("LIMIT " + pageSize);
        return articleMapper.selectPage(new Page<>(), wrapper);
    }

    /**
     * æ–¹æ¡ˆäºŒï¼šå»¶è¿Ÿå…³è”ï¼ˆé€‚ç”¨äºæ·±åˆ†é¡µï¼‰
     */
    public Page<Article> getPageByDelayJoin(Long current, Long size) {
        // å…ˆæŸ¥ID
        List<Long> ids = articleMapper.selectIds(
            new QueryWrapper<Article>()
                .select("id")
                .orderByDesc("create_time")
                .last("LIMIT " + ((current - 1) * size) + ", " + size)
        );

        if (CollectionUtils.isEmpty(ids)) {
            return new Page<>();
        }

        // å†æŸ¥å®Œæ•´æ•°æ®
        return articleMapper.selectPage(
            new Page<>(current, size),
            new QueryWrapper<Article>().in("id", ids)
        );
    }

    /**
     * æ–¹æ¡ˆä¸‰ï¼šESæŸ¥è¯¢ï¼ˆè¶…æ·±åˆ†é¡µï¼‰
     */
    public Page<Article> getPageByES(Long current, Long size, String keyword) {
        NativeSearchQuery query = new NativeSearchQueryBuilder()
            .withQuery(QueryBuilders.multiMatchQuery(keyword, "title", "summary"))
            .withPageable(PageRequest.of((int)(current - 1), (int)size))
            .build();

        SearchHits<ArticleDocument> hits = elasticsearchTemplate.search(query, ArticleDocument.class);

        return new Page<>(
            hits.getSearchHits().stream().map(hit -> convertToArticle(hit.getContent())).collect(Collectors.toList()),
            current,
            size,
            hits.getTotalHits()
        );
    }
}
```

#### 3.5.2 æ‰¹é‡æ“ä½œä¼˜åŒ–

```java
/**
 * æ‰¹é‡æ“ä½œä¼˜åŒ–
 */
@Service
public class BatchOperationService {

    /**
     * æ‰¹é‡æ’å…¥ä¼˜åŒ–
     */
    public void batchInsert(List<Article> articles) {
        // âŒ ä¸å¥½çš„åšæ³•
        // for (Article article : articles) {
        //     articleMapper.insert(article);
        // }

        // âœ… ä½¿ç”¨MyBatis-Plusæ‰¹é‡æ’å…¥
        articleMapper.insertBatch(articles);

        // âœ… æˆ–è€…ä½¿ç”¨æ‰¹é‡SQL
        sqlSession.insert("com.lilong.blogact.mapper.ArticleMapper.batchInsert", articles);
    }

    /**
     * æ‰¹é‡æ›´æ–°ä¼˜åŒ–
     */
    public void batchUpdateViewCount(Map<Long, Integer> viewCountMap) {
        // âŒ ä¸å¥½çš„åšæ³•
        // viewCountMap.forEach((id, count) -> {
        //     articleMapper.updateViewById(id, count);
        // });

        // âœ… ä½¿ç”¨CASE WHENæ‰¹é‡æ›´æ–°
        articleMapper.batchUpdateViewCount(viewCountMap);
    }
}
```

#### 3.5.3 é¿å…N+1æŸ¥è¯¢

```java
/**
 * æ–‡ç« åˆ—è¡¨æŸ¥è¯¢ä¼˜åŒ–ï¼ˆè§£å†³N+1é—®é¢˜ï¼‰
 */
@Service
public class ArticleListService {

    /**
     * âŒ N+1æŸ¥è¯¢é—®é¢˜
     */
    public List<ArticleVO> listWithN1Problem() {
        List<Article> articles = articleMapper.selectList(new QueryWrapper<>());

        // N+1é—®é¢˜ï¼šæ¯ç¯‡æ–‡ç« éƒ½è¦æŸ¥è¯¢ä½œè€…ã€åˆ†ç±»ã€æ ‡ç­¾
        return articles.stream().map(article -> {
            ArticleVO vo = BeanUtil.copyProperties(article, ArticleVO.class);

            // Næ¬¡æŸ¥è¯¢ä½œè€…
            User author = userMapper.selectById(article.getUserId());
            vo.setAuthor(author);

            // Næ¬¡æŸ¥è¯¢åˆ†ç±»
            Category category = categoryMapper.selectById(article.getCategoryId());
            vo.setCategory(category);

            // Næ¬¡æŸ¥è¯¢æ ‡ç­¾
            List<Tag> tags = tagMapper.selectByArticleId(article.getId());
            vo.setTags(tags);

            return vo;
        }).collect(Collectors.toList());
    }

    /**
     * âœ… æ–¹æ¡ˆä¸€ï¼šæ‰¹é‡æŸ¥è¯¢
     */
    public List<ArticleVO> listWithBatchQuery() {
        List<Article> articles = articleMapper.selectList(new QueryWrapper<>());

        // æå–æ‰€æœ‰ID
        List<Long> userIds = articles.stream().map(Article::getUserId).distinct().collect(Collectors.toList());
        List<Integer> categoryIds = articles.stream().map(Article::getCategoryId).distinct().collect(Collectors.toList());
        List<Long> articleIds = articles.stream().map(Article::getId).collect(Collectors.toList());

        // æ‰¹é‡æŸ¥è¯¢
        Map<Long, User> userMap = userService.listByIds(userIds).stream().collect(Collectors.toMap(User::getId, u -> u));
        Map<Integer, Category> categoryMap = categoryService.listByIds(categoryIds).stream().collect(Collectors.toMap(Category::getId, c -> c));
        Map<Long, List<Tag>> tagMap = tagService.listByArticleIds(articleIds);

        // ç»„è£…æ•°æ®
        return articles.stream().map(article -> {
            ArticleVO vo = BeanUtil.copyProperties(article, ArticleVO.class);
            vo.setAuthor(userMap.get(article.getUserId()));
            vo.setCategory(categoryMap.get(article.getCategoryId()));
            vo.setTags(tagMap.get(article.getId()));
            return vo;
        }).collect(Collectors.toList());
    }

    /**
     * âœ… æ–¹æ¡ˆäºŒï¼šä½¿ç”¨è”è¡¨æŸ¥è¯¢ï¼ˆä¸€æ¬¡æ€§æŸ¥è¯¢ï¼‰
     */
    public List<ArticleVO> listWithJoinQuery() {
        return articleMapper.selectArticleWithDetails(new Page<>(1, 20));
    }
}
```

### 3.6 æ•°æ®åº“è¿æ¥æ± ä¼˜åŒ–

```yaml
spring:
  datasource:
    type: com.zaxxer.hikari.HikariDataSource
    hikari:
      # åŸºç¡€é…ç½®
      minimum-idle: 10                    # æœ€å°ç©ºé—²è¿æ¥æ•°
      maximum-pool-size: 100              # æœ€å¤§è¿æ¥æ± å¤§å°ï¼ˆæ ¹æ®å®é™…è°ƒæ•´ï¼‰
      connection-timeout: 30000           # è¿æ¥è¶…æ—¶æ—¶é—´ï¼ˆæ¯«ç§’ï¼‰
      idle-timeout: 600000                # ç©ºé—²è¿æ¥è¶…æ—¶æ—¶é—´ï¼ˆ10åˆ†é’Ÿï¼‰
      max-lifetime: 1800000               # è¿æ¥æœ€å¤§ç”Ÿå‘½å‘¨æœŸï¼ˆ30åˆ†é’Ÿï¼‰

      # æ€§èƒ½ä¼˜åŒ–
      auto-commit: true                   # è‡ªåŠ¨æäº¤
      connection-test-query: SELECT 1     # è¿æ¥æµ‹è¯•æŸ¥è¯¢
      validation-timeout: 3000            # éªŒè¯è¶…æ—¶ï¼ˆ3ç§’ï¼‰

      # è¿æ¥å±æ€§
      connection-init-sql: SET NAMES utf8mb4  # åˆå§‹åŒ–SQL
      pool-name: BlogHikariCP             # è¿æ¥æ± åç§°

      # ç›‘æ§
      register-mbeans: true               # æ³¨å†ŒJMX
      allow-pool-suspension: false        # æ˜¯å¦å…è®¸æš‚åœ
```

---

## 4. ç¼“å­˜æ¶æ„ä¼˜åŒ–

### 4.1 å¤šçº§ç¼“å­˜æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    æµè§ˆå™¨ç¼“å­˜ (Browser Cache)                 â”‚
â”‚                  LocalStorage / SessionStorage              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      CDN ç¼“å­˜ (é™æ€èµ„æº)                      â”‚
â”‚                å›¾ç‰‡ã€CSSã€JSã€é™æ€HTML                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              Nginx æœ¬åœ°ç¼“å­˜ (çƒ­ç‚¹æ•°æ®)                        â”‚
â”‚                çƒ­é—¨æ–‡ç« ã€é¦–é¡µæ•°æ®ã€åˆ†ç±»åˆ—è¡¨                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    åº”ç”¨æœ¬åœ°ç¼“å­˜ (L1 Cache)                   â”‚
â”‚                 Caffeine / Guava Cache                      â”‚
â”‚            å®¹é‡: 10000, è¿‡æœŸ: 5åˆ†é’Ÿ, å‘½ä¸­ç‡: 80%             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              Redis åˆ†å¸ƒå¼ç¼“å­˜ (L2 Cache)                     â”‚
â”‚               Redis Cluster (3ä¸»3ä»)                        â”‚
â”‚              å®¹é‡: 50GB, è¿‡æœŸ: 30åˆ†é’Ÿ, å‘½ä¸­ç‡: 95%           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   MySQL æ•°æ®åº“                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 4.2 æœ¬åœ°ç¼“å­˜å®ç°ï¼ˆCaffeineï¼‰

```java
/**
 * Caffeine æœ¬åœ°ç¼“å­˜é…ç½®
 */
@Configuration
public class CaffeineCacheConfig {

    /**
     * æ–‡ç« æœ¬åœ°ç¼“å­˜
     */
    @Bean("articleLocalCache")
    public Cache<String, ArticleVO> articleLocalCache() {
        return Caffeine.newBuilder()
            // åˆå§‹å®¹é‡
            .initialCapacity(1000)
            // æœ€å¤§å®¹é‡ï¼ˆä½¿ç”¨LRUæ·˜æ±°ï¼‰
            .maximumSize(10000)
            // å†™å…¥åè¿‡æœŸæ—¶é—´
            .expireAfterWrite(5, TimeUnit.MINUTES)
            // æ›´æ–°åè¿‡æœŸæ—¶é—´
            .expireAfterUpdate(5, TimeUnit.MINUTES)
            // å¼€å¯ç»Ÿè®¡
            .recordStats()
            // ç§»é™¤ç›‘å¬
            .removalListener((key, value, cause) -> {
                log.info("æ–‡ç« æœ¬åœ°ç¼“å­˜ç§»é™¤: key={}, cause={}", key, cause);
            })
            .build();
    }

    /**
     * ç”¨æˆ·æœ¬åœ°ç¼“å­˜
     */
    @Bean("userLocalCache")
    public Cache<Long, UserVO> userLocalCache() {
        return Caffeine.newBuilder()
            .initialCapacity(500)
            .maximumSize(5000)
            .expireAfterWrite(10, TimeUnit.MINUTES)
            .recordStats()
            .build();
    }

    /**
     * çƒ­ç‚¹æ•°æ®æœ¬åœ°ç¼“å­˜
     */
    @Bean("hotDataCache")
    public Cache<String, Object> hotDataCache() {
        return Caffeine.newBuilder()
            .maximumSize(1000)
            .expireAfterWrite(1, TimeUnit.MINUTES)
            .recordStats()
            .build();
    }
}
```

### 4.3 å¤šçº§ç¼“å­˜æœåŠ¡

```java
/**
 * å¤šçº§ç¼“å­˜æœåŠ¡
 */
@Service
public class MultiLevelCacheService {

    @Autowired
    @Qualifier("articleLocalCache")
    private Cache<String, ArticleVO> articleLocalCache;

    @Autowired
    private RedisService redisService;

    /**
     * è·å–æ–‡ç« ï¼ˆå¤šçº§ç¼“å­˜ï¼‰
     */
    public ArticleVO getArticle(Long articleId) {
        String key = "article:" + articleId;

        // L1: æœ¬åœ°ç¼“å­˜
        ArticleVO article = articleLocalCache.getIfPresent(key);
        if (article != null) {
            log.debug("æœ¬åœ°ç¼“å­˜å‘½ä¸­: key={}", key);
            return article;
        }

        // L2: Redisç¼“å­˜
        String redisValue = redisService.get(key);
        if (redisValue != null) {
            log.debug("Redisç¼“å­˜å‘½ä¸­: key={}", key);
            article = JsonUtil.fromJson(redisValue, ArticleVO.class);
            // å†™å…¥æœ¬åœ°ç¼“å­˜
            articleLocalCache.put(key, article);
            return article;
        }

        // L3: æ•°æ®åº“
        log.debug("ç¼“å­˜æœªå‘½ä¸­ï¼ŒæŸ¥è¯¢æ•°æ®åº“: key={}", key);
        article = loadArticleFromDB(articleId);

        if (article != null) {
            // å†™å…¥Redisï¼ˆ30åˆ†é’Ÿè¿‡æœŸï¼‰
            redisService.set(key, JsonUtil.toJsonString(article), 1800);
            // å†™å…¥æœ¬åœ°ç¼“å­˜
            articleLocalCache.put(key, article);
        }

        return article;
    }

    /**
     * åˆ é™¤ç¼“å­˜ï¼ˆç©¿é€æ›´æ–°ï¼‰
     */
    public void evictArticle(Long articleId) {
        String key = "article:" + articleId;
        // åˆ é™¤æœ¬åœ°ç¼“å­˜
        articleLocalCache.invalidate(key);
        // åˆ é™¤Redisç¼“å­˜
        redisService.remove(key);
    }

    /**
     * æ‰¹é‡åˆ é™¤ç¼“å­˜
     */
    public void evictArticleList() {
        // åˆ é™¤æœ¬åœ°ç¼“å­˜ï¼ˆé€šè¿‡å‰ç¼€ï¼‰
        Iterator<String> iterator = articleLocalCache.asMap().keySet().iterator();
        while (iterator.hasNext()) {
            String key = iterator.next();
            if (key.startsWith("article:")) {
                iterator.remove();
            }
        }

        // åˆ é™¤Redisç¼“å­˜ï¼ˆé€šè¿‡SCANï¼‰
        Set<String> keys = redisService.keys("article:*");
        redisService.removeAll(keys);
    }

    /**
     * è·å–ç¼“å­˜ç»Ÿè®¡ä¿¡æ¯
     */
    public Map<String, Object> getCacheStats() {
        CacheStats stats = articleLocalCache.stats();
        Map<String, Object> result = new HashMap<>();
        result.put("hitRate", stats.hitRate());
        result.put("hitCount", stats.hitCount());
        result.put("missCount", stats.missCount());
        result.put("loadSuccessCount", stats.loadSuccessCount());
        result.put("loadFailureCount", stats.loadFailureCount());
        result.put("totalLoadTime", stats.totalLoadTime());
        result.put("evictionCount", stats.evictionCount());
        return result;
    }
}
```

### 4.4 Redisé›†ç¾¤é…ç½®

```yaml
spring:
  redis:
    cluster:
      nodes:
        - 192.168.1.100:7000
        - 192.168.1.100:7001
        - 192.168.1.101:7002
        - 192.168.1.101:7003
        - 192.168.1.102:7004
        - 192.168.1.102:7005
      max-redirects: 3
    lettuce:
      pool:
        max-active: 100
        max-idle: 50
        min-idle: 10
        max-wait: 3000ms
    timeout: 3000ms
    password: your_password
```

### 4.5 ç¼“å­˜Keyè®¾è®¡è§„èŒƒ

```java
/**
 * Redis Keyè®¾è®¡è§„èŒƒ
 */
public class RedisKeyConstants {

    // ==================================== Keyå‘½åè§„èŒƒ ====================================
    // æ ¼å¼: ä¸šåŠ¡:æ¨¡å—:æ“ä½œ:æ ‡è¯†
    // ç¤ºä¾‹: blog:article:info:12345

    // ==================================== æ–‡ç« ç›¸å…³ ====================================
    /**
     * æ–‡ç« è¯¦æƒ…
     * æ•°æ®ç±»å‹: String
     * è¿‡æœŸæ—¶é—´: 30åˆ†é’Ÿ
     */
    public static final String ARTICLE_INFO = "blog:article:info:%s";

    /**
     * æ–‡ç« åˆ—è¡¨
     * æ•°æ®ç±»å‹: Hash
     * è¿‡æœŸæ—¶é—´: 10åˆ†é’Ÿ
     */
    public static final String ARTICLE_LIST = "blog:article:list:%s";

    /**
     * çƒ­é—¨æ–‡ç« ï¼ˆZSetæŒ‰åˆ†æ•°æ’åºï¼‰
     * æ•°æ®ç±»å‹: ZSet
     * è¿‡æœŸæ—¶é—´: 1å°æ—¶
     * åˆ†æ•°: ç»¼åˆè¯„åˆ†
     */
    public static final String HOT_ARTICLE = "blog:article:hot:%s";

    /**
     * æ–‡ç« ç‚¹èµç”¨æˆ·é›†åˆ
     * æ•°æ®ç±»å‹: Set
     * è¿‡æœŸæ—¶é—´: 24å°æ—¶
     */
    public static final String ARTICLE_LIKE_USERS = "blog:article:like:%s";

    /**
     * ç”¨æˆ·æ–‡ç« åˆ—è¡¨ï¼ˆä½¿ç”¨Hash Tagç¡®ä¿åœ¨åŒä¸€åˆ†ç‰‡ï¼‰
     * æ•°æ®ç±»å‹: List
     * è¿‡æœŸæ—¶é—´: 30åˆ†é’Ÿ
     */
    public static final String USER_ARTICLES = "blog:user:{%s}:articles";

    // ==================================== ç”¨æˆ·ç›¸å…³ ====================================
    /**
     * ç”¨æˆ·ä¿¡æ¯
     * æ•°æ®ç±»å‹: String
     * è¿‡æœŸæ—¶é—´: 1å°æ—¶
     */
    public static final String USER_INFO = "blog:user:info:%s";

    /**
     * ç”¨æˆ·ç²‰ä¸åˆ—è¡¨
     * æ•°æ®ç±»å‹: ZSet
     * è¿‡æœŸæ—¶é—´: 30åˆ†é’Ÿ
     */
    public static final String USER_FOLLOWERS = "blog:user:followers:%s";

    /**
     * ç”¨æˆ·å…³æ³¨åˆ—è¡¨
     * æ•°æ®ç±»å‹: ZSet
     * è¿‡æœŸæ—¶é—´: 30åˆ†é’Ÿ
     */
    public static final String USER_FOLLOWING = "blog:user:following:%s";

    // ==================================== è¯„è®ºç›¸å…³ ====================================
    /**
     * æ–‡ç« è¯„è®ºåˆ—è¡¨
     * æ•°æ®ç±»å‹: List
     * è¿‡æœŸæ—¶é—´: 10åˆ†é’Ÿ
     */
    public static final String ARTICLE_COMMENTS = "blog:article:comments:%s";

    /**
     * è¯„è®ºç‚¹èµç”¨æˆ·é›†åˆ
     * æ•°æ®ç±»å‹: Set
     * è¿‡æœŸæ—¶é—´: 24å°æ—¶
     */
    public static final String COMMENT_LIKE_USERS = "blog:comment:like:%s";

    // ==================================== ç»Ÿè®¡ç›¸å…³ ====================================
    /**
     * æ–‡ç« é˜…è¯»é‡è®¡æ•°å™¨
     * æ•°æ®ç±»å‹: String
     * è¿‡æœŸæ—¶é—´: 1å°æ—¶ï¼ˆå®šæ—¶åŒæ­¥åˆ°æ•°æ®åº“ï¼‰
     */
    public static final String ARTICLE_VIEW_COUNT = "blog:article:view:count:%s";

    /**
     * ç”¨æˆ·ä»Šæ—¥é˜…è¯»æ–‡ç« é›†åˆï¼ˆå»é‡ï¼‰
     * æ•°æ®ç±»å‹: Set
     * è¿‡æœŸæ—¶é—´: 24å°æ—¶
     */
    public static final String USER_VIEW_ARTICLES_TODAY = "blog:user:view:%s:%s";

    // ==================================== åˆ†å¸ƒå¼é” ====================================
    /**
     * æ–‡ç« ç‚¹èµé”
     */
    public static final String ARTICLE_LIKE_LOCK = "blog:lock:article:like:%s";

    /**
     * æ–‡ç« æµè§ˆé”
     */
    public static final String ARTICLE_VIEW_LOCK = "blog:lock:article:view:%s";

    // ==================================== é™æµ ====================================
    /**
     * æ¥å£é™æµ
     */
    public static final String RATE_LIMIT = "blog:rate:limit:%s:%s";

    /**
     * é˜²åˆ·é™æµ
     */
    public static final String ANI_BRUSH = "blog:anti:brush:%s:%s";
}
```

### 4.6 ç¼“å­˜ç©¿é€è§£å†³æ–¹æ¡ˆ

```java
/**
 * ç¼“å­˜ç©¿é€é˜²æŠ¤
 */
@Service
public class CachePenetrationService {

    @Autowired
    private RedisService redisService;

    @Autowired
    private ArticleMapper articleMapper;

    /**
     * æ–¹æ¡ˆä¸€ï¼šå¸ƒéš†è¿‡æ»¤å™¨
     */
    private BloomFilter<Long> articleBloomFilter;

    @PostConstruct
    public void initBloomFilter() {
        // é¢„è®¡1000ä¸‡æ•°æ®ï¼Œè¯¯åˆ¤ç‡0.01%
        articleBloomFilter = BloomFilter.create(
            Funnels.longFunnel(),
            10000000,
            0.0001
        );

        // åŠ è½½æ‰€æœ‰æ–‡ç« ID
        List<Long> allIds = articleMapper.selectAllIds();
        allIds.forEach(articleBloomFilter::put);

        log.info("å¸ƒéš†è¿‡æ»¤å™¨åˆå§‹åŒ–å®Œæˆï¼Œæ•°æ®é‡: {}", allIds.size());
    }

    /**
     * ä½¿ç”¨å¸ƒéš†è¿‡æ»¤å™¨é˜²æ­¢ç¼“å­˜ç©¿é€
     */
    public Article getArticleWithBloomFilter(Long articleId) {
        // 1. å¸ƒéš†è¿‡æ»¤å™¨åˆ¤æ–­
        if (!articleBloomFilter.mightContain(articleId)) {
            log.warn("å¸ƒéš†è¿‡æ»¤å™¨åˆ¤æ–­æ–‡ç« ä¸å­˜åœ¨: id={}", articleId);
            return null;
        }

        // 2. æŸ¥è¯¢ç¼“å­˜
        String key = String.format(RedisKeyConstants.ARTICLE_INFO, articleId);
        String value = redisService.get(key);

        if (value != null) {
            if ("NULL".equals(value)) {
                return null;  // ç©ºå¯¹è±¡
            }
            return JsonUtil.fromJson(value, Article.class);
        }

        // 3. æŸ¥è¯¢æ•°æ®åº“
        Article article = articleMapper.selectById(articleId);

        if (article != null) {
            redisService.set(key, JsonUtil.toJsonString(article), 1800);
        } else {
            // ç¼“å­˜ç©ºå¯¹è±¡ï¼Œè¾ƒçŸ­è¿‡æœŸæ—¶é—´
            redisService.set(key, "NULL", 60);
        }

        return article;
    }

    /**
     * æ–¹æ¡ˆäºŒï¼šç¼“å­˜ç©ºå¯¹è±¡
     */
    public Article getArticleWithNullCache(Long articleId) {
        String key = String.format(RedisKeyConstants.ARTICLE_INFO, articleId);
        String value = redisService.get(key);

        if (value != null) {
            if ("NULL".equals(value)) {
                return null;
            }
            return JsonUtil.fromJson(value, Article.class);
        }

        Article article = articleMapper.selectById(articleId);

        if (article != null) {
            redisService.set(key, JsonUtil.toJsonString(article), 1800);
        } else {
            redisService.set(key, "NULL", 60);  // ç©ºå¯¹è±¡ç¼“å­˜1åˆ†é’Ÿ
        }

        return article;
    }
}
```

### 4.7 ç¼“å­˜å‡»ç©¿è§£å†³æ–¹æ¡ˆ

```java
/**
 * ç¼“å­˜å‡»ç©¿é˜²æŠ¤
 */
@Service
public class CacheBreakdownService {

    @Autowired
    private RedisService redisService;

    @Autowired
    private RedissonClient redissonClient;

    /**
     * æ–¹æ¡ˆä¸€ï¼šäº’æ–¥é”ï¼ˆRedissonåˆ†å¸ƒå¼é”ï¼‰
     */
    public Article getArticleWithLock(Long articleId) {
        String key = String.format(RedisKeyConstants.ARTICLE_INFO, articleId);
        String value = redisService.get(key);

        if (value != null) {
            return JsonUtil.fromJson(value, Article.class);
        }

        // è·å–åˆ†å¸ƒå¼é”
        String lockKey = "lock:article:" + articleId;
        RLock lock = redissonClient.getLock(lockKey);

        try {
            // å°è¯•åŠ é”ï¼Œæœ€å¤šç­‰å¾…3ç§’ï¼Œé”30ç§’åè‡ªåŠ¨é‡Šæ”¾
            if (lock.tryLock(3, 30, TimeUnit.SECONDS)) {
                // åŒé‡æ£€æŸ¥
                value = redisService.get(key);
                if (value != null) {
                    return JsonUtil.fromJson(value, Article.class);
                }

                // æŸ¥è¯¢æ•°æ®åº“
                Article article = articleMapper.selectById(articleId);
                if (article != null) {
                    redisService.set(key, JsonUtil.toJsonString(article), 1800);
                }
                return article;
            }
        } catch (InterruptedException e) {
            Thread.currentThread().interrupt();
            log.error("è·å–åˆ†å¸ƒå¼é”è¢«ä¸­æ–­: articleId={}", articleId, e);
        } finally {
            if (lock.isHeldByCurrentThread()) {
                lock.unlock();
            }
        }

        // è·å–é”å¤±è´¥ï¼Œè¿”å›é™çº§æ•°æ®æˆ–é‡è¯•
        return getDegradedArticle(articleId);
    }

    /**
     * æ–¹æ¡ˆäºŒï¼šé€»è¾‘è¿‡æœŸï¼ˆå¼‚æ­¥é‡å»ºï¼‰
     */
    @Data
    @AllArgsConstructor
    @NoArgsConstructor
    public static class CacheData<T> {
        private T data;
        private Long expireTime;  // é€»è¾‘è¿‡æœŸæ—¶é—´æˆ³
    }

    private final ExecutorService rebuildCacheExecutor = new ThreadPoolExecutor(
        10, 50, 60, TimeUnit.SECONDS,
        new LinkedBlockingQueue<>(1000),
        new ThreadFactoryBuilder().setNameFormat("cache-rebuild-%d").build()
    );

    public Article getArticleWithLogicalExpire(Long articleId) {
        String key = String.format(RedisKeyConstants.ARTICLE_INFO, articleId);
        String value = redisService.get(key);

        if (value != null) {
            CacheData<Article> cacheData = JsonUtil.fromJson(value,
                new TypeReference<CacheData<Article>>() {});

            // æ£€æŸ¥é€»è¾‘è¿‡æœŸæ—¶é—´
            if (cacheData.getExpireTime() > System.currentTimeMillis()) {
                return cacheData.getData();  // æœªè¿‡æœŸ
            }

            // å·²è¿‡æœŸï¼Œå¼‚æ­¥é‡å»ºç¼“å­˜
            rebuildCacheAsync(articleId);

            // è¿”å›æ—§æ•°æ®
            return cacheData.getData();
        }

        // ç¼“å­˜ä¸å­˜åœ¨ï¼ŒæŸ¥è¯¢æ•°æ®åº“
        Article article = articleMapper.selectById(articleId);

        if (article != null) {
            // è®¾ç½®é€»è¾‘è¿‡æœŸæ—¶é—´ï¼ˆæ¯”å®é™…è¿‡æœŸæ—¶é—´é•¿ï¼‰
            CacheData<Article> cacheData = new CacheData<>(
                article,
                System.currentTimeMillis() + 5 * 60 * 1000  // 5åˆ†é’Ÿåé€»è¾‘è¿‡æœŸ
            );

            // å®é™…è¿‡æœŸæ—¶é—´10åˆ†é’Ÿ
            redisService.set(key, JsonUtil.toJsonString(cacheData), 600);
        }

        return article;
    }

    /**
     * å¼‚æ­¥é‡å»ºç¼“å­˜
     */
    @Async("rebuildCacheExecutor")
    public void rebuildCacheAsync(Long articleId) {
        String lockKey = "lock:rebuild:" + articleId;
        RLock lock = redissonClient.getLock(lockKey);

        if (lock.tryLock()) {
            try {
                // æŸ¥è¯¢æœ€æ–°æ•°æ®
                Article article = articleMapper.selectById(articleId);

                if (article != null) {
                    // è®¾ç½®é€»è¾‘è¿‡æœŸæ—¶é—´
                    CacheData<Article> cacheData = new CacheData<>(
                        article,
                        System.currentTimeMillis() + 5 * 60 * 1000
                    );

                    String key = String.format(RedisKeyConstants.ARTICLE_INFO, articleId);
                    redisService.set(key, JsonUtil.toJsonString(cacheData), 600);

                    log.info("ç¼“å­˜é‡å»ºæˆåŠŸ: articleId={}", articleId);
                }
            } finally {
                lock.unlock();
            }
        }
    }
}
```

### 4.8 ç¼“å­˜é›ªå´©è§£å†³æ–¹æ¡ˆ

```java
/**
 * ç¼“å­˜é›ªå´©é˜²æŠ¤
 */
@Service
public class CacheAvalancheService {

    @Autowired
    private MultiLevelCacheService multiLevelCacheService;

    private final Random random = new Random();

    /**
     * æ–¹æ¡ˆä¸€ï¼šéšæœºè¿‡æœŸæ—¶é—´
     */
    public void setWithRandomExpire(String key, String value, int baseExpire) {
        // åŸºç¡€è¿‡æœŸæ—¶é—´ + éšæœºæ—¶é—´ï¼ˆ0-30%ï¼‰
        int randomExpire = (int) (baseExpire * 0.3 * random.nextDouble());
        int totalExpire = baseExpire + randomExpire;

        redisService.set(key, value, totalExpire);
    }

    /**
     * æ–¹æ¡ˆäºŒï¼šå¤šçº§ç¼“å­˜ï¼ˆL1æœ¬åœ° + L2Redisï¼‰
     */
    public Article getArticleWithMultiLevel(Long articleId) {
        // å¤šçº§ç¼“å­˜è‡ªåŠ¨é™çº§
        return multiLevelCacheService.getArticle(articleId);
    }

    /**
     * æ–¹æ¡ˆä¸‰ï¼šç¼“å­˜é¢„çƒ­
     */
    @Scheduled(cron = "0 */10 * * * ?")  // æ¯10åˆ†é’Ÿæ‰§è¡Œ
    public void warmUpHotData() {
        log.info("å¼€å§‹ç¼“å­˜é¢„çƒ­...");

        // é¢„çƒ­çƒ­é—¨æ–‡ç« 
        List<Article> hotArticles = articleMapper.selectHotArticles(100);
        for (Article article : hotArticles) {
            String key = String.format(RedisKeyConstants.HOT_ARTICLE, article.getId());
            redisService.set(key, JsonUtil.toJsonString(article), 3600);
        }

        // é¢„çƒ­åˆ†ç±»åˆ—è¡¨
        List<Category> categories = categoryMapper.selectList(new QueryWrapper<>());
        redisService.set("blog:category:list", JsonUtil.toJsonString(categories), 7200);

        log.info("ç¼“å­˜é¢„çƒ­å®Œæˆ");
    }

    /**
     * æ–¹æ¡ˆå››ï¼šé™æµé™çº§
     */
    @RateLimiter(value = 100, timeout = 1)  // æ¯ç§’æœ€å¤š100ä¸ªè¯·æ±‚
    public Article getArticleWithRateLimit(Long articleId) {
        return getArticleWithMultiLevel(articleId);
    }
}
```

### 4.9 çƒ­ç‚¹æ•°æ®å‘ç°ä¸ç¼“å­˜

```java
/**
 * çƒ­ç‚¹æ•°æ®è‡ªåŠ¨ç¼“å­˜
 */
@Service
public class HotDataCacheService {

    @Autowired
    private RedisService redisService;

    /**
     * è®¿é—®è®¡æ•°å™¨ï¼ˆæœ¬åœ°ç¼“å­˜ï¼‰
     */
    private final LoadingCache<Long, AtomicLong> accessCounter = Caffeine.newBuilder()
        .maximumSize(10000)
        .expireAfterWrite(1, TimeUnit.MINUTES)
        .build(key -> new AtomicLong(0));

    /**
     * è®°å½•è®¿é—®
     */
    public void recordAccess(Long articleId) {
        AtomicLong counter = accessCounter.get(articleId);
        long count = counter.incrementAndGet();

        // è¶…è¿‡é˜ˆå€¼ï¼Œè‡ªåŠ¨ç¼“å­˜åˆ°Redis
        if (count == 100) {
            cacheHotArticle(articleId);
        } else if (count % 1000 == 0) {
            // æ¯1000æ¬¡è®¿é—®ï¼Œåˆ·æ–°ç¼“å­˜
            refreshHotArticleCache(articleId);
        }
    }

    /**
     * ç¼“å­˜çƒ­ç‚¹æ–‡ç« 
     */
    @Async
    public void cacheHotArticle(Long articleId) {
        Article article = articleMapper.selectById(articleId);
        if (article != null) {
            String key = String.format(RedisKeyConstants.HOT_ARTICLE, articleId);
            redisService.set(key, JsonUtil.toJsonString(article), 3600);  // 1å°æ—¶

            // æ·»åŠ åˆ°çƒ­é—¨æ–‡ç« æ’è¡Œæ¦œ
            String hotKey = "blog:article:hot:rank";
            redisService.zadd(hotKey, articleId.toString(), System.currentTimeMillis());
            redisService.zremoveRangeByScore(hotKey, 0, System.currentTimeMillis() - 86400000);  // åªä¿ç•™24å°æ—¶
        }
    }

    /**
     * åˆ·æ–°çƒ­ç‚¹æ–‡ç« ç¼“å­˜
     */
    @Async
    public void refreshHotArticleCache(Long articleId) {
        Article article = articleMapper.selectById(articleId);
        if (article != null) {
            String key = String.format(RedisKeyConstants.HOT_ARTICLE, articleId);
            redisService.set(key, JsonUtil.toJsonString(article), 3600);
        }
    }

    /**
     * è·å–çƒ­é—¨æ–‡ç« æ’è¡Œ
     */
    public List<Long> getHotArticleRank(int limit) {
        String hotKey = "blog:article:hot:rank";
        Set<String> articleIds = redisService.zreverseRange(hotKey, 0, limit - 1);

        return articleIds.stream()
            .map(Long::parseLong)
            .collect(Collectors.toList());
    }
}
```

---

## 5. æ¶ˆæ¯é˜Ÿåˆ—åº”ç”¨

### 5.1 å¼‚æ­¥è§£è€¦åœºæ™¯

#### 5.1.1 æ–‡ç« å‘å¸ƒå¼‚æ­¥å¤„ç†

```java
/**
 * æ–‡ç« å‘å¸ƒæ¶ˆæ¯å®šä¹‰
 */
@Data
@Builder
@AllArgsConstructor
@NoArgsConstructor
public class ArticlePublishedMessage implements Serializable {
    private Long articleId;
    private Long userId;
    private String title;
    private Integer categoryId;
    private List<String> tags;
    private LocalDateTime publishTime;
}

/**
 * æ–‡ç« å‘å¸ƒæœåŠ¡
 */
@Service
public class ArticlePublishService {

    @Autowired
    private RocketMQTemplate rocketMQTemplate;

    @Autowired
    private ArticleMapper articleMapper;

    @Autowired
    private RedisService redisService;

    /**
     * å‘å¸ƒæ–‡ç« 
     */
    @Transactional(rollbackFor = Exception.class)
    public Long publishArticle(ArticleDTO dto) {
        // 1. ä¿å­˜æ–‡ç« åˆ°æ•°æ®åº“
        Article article = BeanUtil.copyProperties(dto, Article.class);
        article.setCreateTime(LocalDateTime.now());
        article.setUpdateTime(LocalDateTime.now());
        articleMapper.insert(article);

        // 2. æ¸…é™¤ç¼“å­˜
        String key = String.format(RedisKeyConstants.ARTICLE_INFO, article.getId());
        redisService.remove(key);

        // 3. å‘é€æ¶ˆæ¯åˆ°MQï¼ˆå¼‚æ­¥å¤„ç†åç»­æ“ä½œï¼‰
        ArticlePublishedMessage message = ArticlePublishedMessage.builder()
            .articleId(article.getId())
            .userId(article.getUserId())
            .title(article.getTitle())
            .categoryId(article.getCategoryId())
            .tags(dto.getTags())
            .publishTime(LocalDateTime.now())
            .build();

        rocketMQTemplate.asyncSend("article-published-topic", message, new SendCallback() {
            @Override
            public void onSuccess(SendResult sendResult) {
                log.info("æ–‡ç« å‘å¸ƒæ¶ˆæ¯å‘é€æˆåŠŸ: articleId={}", article.getId());
            }

            @Override
            public void onException(Throwable e) {
                log.error("æ–‡ç« å‘å¸ƒæ¶ˆæ¯å‘é€å¤±è´¥: articleId={}", article.getId(), e);
                // å¤±è´¥å¤„ç†ï¼šè®°å½•åˆ°å¤±è´¥é˜Ÿåˆ—ï¼Œåç»­è¡¥å¿
                recordFailedMessage(message);
            }
        });

        return article.getId();
    }
}

/**
 * æ–‡ç« å‘å¸ƒæ¶ˆæ¯æ¶ˆè´¹è€…
 */
@Component
@RocketMQMessageListener(
    topic = "article-published-topic",
    consumerGroup = "article-published-consumer-group",
    consumeMode = ConsumeMode.CONCURRENTLY,
    maxReconsumeTimes = 3
)
public class ArticlePublishedConsumer implements RocketMQListener<ArticlePublishedMessage> {

    @Autowired
    private SearchService searchService;

    @Autowired
    private StatisticsService statisticsService;

    @Autowired
    private NotificationService notificationService;

    @Autowired
    private CacheService cacheService;

    @Autowired
    private ScoreService scoreService;

    @Override
    public void onMessage(ArticlePublishedMessage message) {
        try {
            log.info("å¼€å§‹å¤„ç†æ–‡ç« å‘å¸ƒæ¶ˆæ¯: articleId={}", message.getArticleId());

            // 1. åŒæ­¥åˆ°æœç´¢å¼•æ“
            searchService.indexArticle(message.getArticleId());

            // 2. æ›´æ–°ç”¨æˆ·æ–‡ç« æ•°ç»Ÿè®¡
            statisticsService.incrementArticleCount(message.getUserId());

            // 3. é€šçŸ¥ç²‰ä¸
            notificationService.notifyFollowers(message);

            // 4. æ›´æ–°åˆ†ç±»æ–‡ç« æ•°
            statisticsService.incrementCategoryCount(message.getCategoryId());

            // 5. æ¸…é™¤ç›¸å…³ç¼“å­˜
            cacheService.evictArticleListCache();
            cacheService.evictCategoryCache(message.getCategoryId());

            // 6. æ›´æ–°æ ‡ç­¾æ–‡ç« æ•°
            if (CollectionUtils.isNotEmpty(message.getTags())) {
                statisticsService.incrementTagCount(message.getTags());
            }

            log.info("æ–‡ç« å‘å¸ƒæ¶ˆæ¯å¤„ç†å®Œæˆ: articleId={}", message.getArticleId());

        } catch (Exception e) {
            log.error("å¤„ç†æ–‡ç« å‘å¸ƒæ¶ˆæ¯å¤±è´¥: articleId={}", message.getArticleId(), e);
            throw e;  // æŠ›å‡ºå¼‚å¸¸è§¦å‘é‡è¯•
        }
    }
}
```

#### 5.1.2 è¯„è®ºå¼‚æ­¥å¤„ç†

```java
/**
 * è¯„è®ºåˆ›å»ºæ¶ˆæ¯
 */
@Data
@Builder
public class CommentCreatedMessage implements Serializable {
    private Long commentId;
    private Long articleId;
    private Long userId;
    private String userName;
    private Long replyUserId;
    private String content;
    private LocalDateTime createTime;
}

/**
 * è¯„è®ºæœåŠ¡
 */
@Service
public class CommentService {

    @Autowired
    private RocketMQTemplate rocketMQTemplate;

    @Autowired
    private CommentMapper commentMapper;

    /**
     * æ·»åŠ è¯„è®º
     */
    @Transactional(rollbackFor = Exception.class)
    public Long addComment(CommentDTO dto) {
        // 1. ä¿å­˜è¯„è®º
        Comment comment = BeanUtil.copyProperties(dto, Comment.class);
        comment.setCreateTime(LocalDateTime.now());
        commentMapper.insert(comment);

        // 2. å‘é€æ¶ˆæ¯
        CommentCreatedMessage message = CommentCreatedMessage.builder()
            .commentId(comment.getId())
            .articleId(comment.getArticleId())
            .userId(comment.getUserId())
            .userName(dto.getUserName())
            .replyUserId(dto.getReplyUserId())
            .content(comment.getContent())
            .createTime(LocalDateTime.now())
            .build();

        rocketMQTemplate.syncSend("comment-created-topic", message);

        return comment.getId();
    }
}

/**
 * è¯„è®ºæ¶ˆæ¯æ¶ˆè´¹è€…
 */
@Component
@RocketMQMessageListener(
    topic = "comment-created-topic",
    consumerGroup = "comment-created-consumer-group"
)
public class CommentCreatedConsumer implements RocketMQListener<CommentCreatedMessage> {

    @Autowired
    private ArticleStatisticsService statisticsService;

    @Autowired
    private NotificationService notificationService;

    @Autowired
    private ScoreService scoreService;

    @Autowired
    private CacheService cacheService;

    @Override
    public void onMessage(CommentCreatedMessage message) {
        // 1. æ›´æ–°æ–‡ç« è¯„è®ºæ•°
        statisticsService.incrementCommentCount(message.getArticleId());

        // 2. é€šçŸ¥æ–‡ç« ä½œè€…
        Article article = articleMapper.selectById(message.getArticleId());
        if (!message.getUserId().equals(article.getUserId())) {
            notificationService.notifyComment(article.getUserId(), message);
        }

        // 3. é€šçŸ¥è¢«å›å¤äºº
        if (message.getReplyUserId() != null &&
            !message.getUserId().equals(message.getReplyUserId())) {
            notificationService.notifyReply(message.getReplyUserId(), message);
        }

        // 4. å¢åŠ ç”¨æˆ·ç§¯åˆ†
        scoreService.addScore(message.getUserId(), ScoreAction.COMMENT);

        // 5. æ¸…é™¤ç¼“å­˜
        cacheService.evictArticleDetail(message.getArticleId());
        cacheService.evictCommentList(message.getArticleId());
    }
}
```

### 5.2 å‰Šå³°å¡«è°·åœºæ™¯

```java
/**
 * é˜…è¯»é‡æ›´æ–°ï¼ˆå‰Šå³°ï¼‰
 */
@Service
public class ArticleViewService {

    @Autowired
    private RedisService redisService;

    @Autowired
    private RocketMQTemplate rocketMQTemplate;

    private static final String VIEW_COUNT_KEY = "article:view:count:";
    private static final String VIEW_SET_KEY = "article:view:users:%s:%s";

    /**
     * è®°å½•é˜…è¯»ï¼ˆé«˜å¹¶å‘åœºæ™¯ï¼‰
     */
    public void recordView(Long articleId, Long userId) {
        // 1. æ£€æŸ¥ç”¨æˆ·æ˜¯å¦å·²é˜…è¯»ï¼ˆå»é‡ï¼‰
        String setUserKey = String.format(VIEW_SET_KEY, articleId, LocalDate.now());
        Boolean isRead = redisService.sIsMember(setUserKey, userId.toString());

        if (Boolean.TRUE.equals(isRead)) {
            return;  // ä»Šå¤©å·²é˜…è¯»è¿‡
        }

        // 2. è®°å½•ç”¨æˆ·é˜…è¯»
        redisService.sadd(setUserKey, userId.toString());
        redisService.expire(setUserKey, 86400);  // 24å°æ—¶è¿‡æœŸ

        // 3. Redisè®¡æ•°å™¨ï¼ˆç”¨äºå®æ—¶æ˜¾ç¤ºï¼‰
        String countKey = VIEW_COUNT_KEY + articleId;

        // ä½¿ç”¨Luaè„šæœ¬ä¿è¯åŸå­æ€§
        String luaScript =
            "local count = redis.call('incr', KEYS[1]) " +
            "if count == 1 then " +
            "    redis.call('expire', KEYS[1], 3600) " +
            "end " +
            "if count % 10 == 0 then " +
            "    redis.call('publish', KEYS[2], ARGV[1]) " +
            "end " +
            "return count";

        redisService.executeScript(
            new DefaultRedisScript<>(luaScript, Long.class),
            Arrays.asList(countKey, "article:view:channel"),
            articleId.toString()
        );
    }

    /**
     * è®¢é˜…é˜…è¯»é‡æ›´æ–°æ¶ˆæ¯
     */
    @RedisListener(channel = "article:view:channel")
    public void onViewCountMessage(String message) {
        Long articleId = Long.parseLong(message);

        // å‘é€MQæ¶ˆæ¯ï¼Œæ‰¹é‡æ›´æ–°åˆ°æ•°æ®åº“
        ArticleViewBatchMessage batchMessage = ArticleViewBatchMessage.builder()
            .articleId(articleId)
            .build();

        rocketMQTemplate.asyncSend("article-view-batch-topic", batchMessage);
    }

    /**
     * æ‰¹é‡æ›´æ–°é˜…è¯»é‡åˆ°æ•°æ®åº“
     */
    @Scheduled(fixedDelay = 60000)  // æ¯åˆ†é’Ÿæ‰§è¡Œ
    public void batchUpdateViewCount() {
        Set<String> keys = redisService.keys(VIEW_COUNT_KEY + "*");

        if (CollectionUtils.isEmpty(keys)) {
            return;
        }

        Map<Long, Long> viewCountMap = new HashMap<>();

        for (String key : keys) {
            Long articleId = Long.parseLong(key.substring(key.lastIndexOf(":") + 1));
            String countStr = redisService.get(key);

            if (countStr != null) {
                Long count = Long.parseLong(countStr);
                if (count > 0) {
                    viewCountMap.put(articleId, count);
                }
            }
        }

        if (!viewCountMap.isEmpty()) {
            // æ‰¹é‡æ›´æ–°æ•°æ®åº“
            articleMapper.batchUpdateViewCount(viewCountMap);

            // æ¸…ç©ºRedisè®¡æ•°
            redisService.removeAll(keys);
        }
    }
}
```

### 5.3 å»¶è¿Ÿæ¶ˆæ¯åº”ç”¨

```java
/**
 * å»¶è¿Ÿæ¶ˆæ¯æœåŠ¡
 */
@Service
public class DelayMessageService {

    @Autowired
    private RocketMQTemplate rocketMQTemplate;

    /**
     * å®šæ—¶å‘å¸ƒæ–‡ç« 
     */
    public void schedulePublish(Long articleId, LocalDateTime publishTime) {
        long delayMillis = ChronoUnit.MILLIS.between(LocalDateTime.now(), publishTime);

        if (delayMillis <= 0) {
            publishArticleNow(articleId);
            return;
        }

        // è®¡ç®—å»¶è¿Ÿçº§åˆ«ï¼ˆ1s 5s 10s 30s 1m 2m 3m 4m 5m 6m 7m 8m 9m 10m 20m 30m 1h 2hï¼‰
        int delayLevel = calculateDelayLevel(delayMillis);

        ArticleScheduleMessage message = ArticleScheduleMessage.builder()
            .articleId(articleId)
            .publishTime(publishTime)
            .build();

        Message<ArticleScheduleMessage> msg = MessageBuilder.withPayload(message).build();
        rocketMQTemplate.syncSend("article-schedule-publish-topic", msg, 3000, delayLevel);
    }

    /**
     * å»¶è¿Ÿåˆ é™¤æ–‡ç« ï¼ˆè½¯åˆ é™¤ï¼‰
     */
    public void delayDeleteArticle(Long articleId, int days) {
        ArticleDeleteMessage message = ArticleDeleteMessage.builder()
            .articleId(articleId)
            .build();

        // 7å¤©ååˆ é™¤ï¼ˆå»¶è¿Ÿçº§åˆ«16 = 2å°æ—¶ï¼Œéœ€è¦å¤šæ¬¡å»¶è¿Ÿæˆ–ä½¿ç”¨å®šæ—¶ä»»åŠ¡ï¼‰
        Message<ArticleDeleteMessage> msg = MessageBuilder.withPayload(message).build();
        rocketMQTemplate.syncSend("article-delay-delete-topic", msg, 3000, 16);
    }

    /**
     * æ–‡ç« å®šæ—¶å½’æ¡£
     */
    public void archiveArticle(Long articleId, LocalDateTime archiveTime) {
        ArticleArchiveMessage message = ArticleArchiveMessage.builder()
            .articleId(articleId)
            .archiveTime(archiveTime)
            .build();

        rocketMQTemplate.syncSend("article-archive-topic", message);
    }

    private int calculateDelayLevel(long delayMillis) {
        if (delayMillis <= 1000) return 1;  // 1s
        if (delayMillis <= 5000) return 2;  // 5s
        if (delayMillis <= 10000) return 3; // 10s
        if (delayMillis <= 30000) return 4; // 30s
        if (delayMillis <= 60000) return 5; // 1m
        if (delayMillis <= 120000) return 6; // 2m
        if (delayMillis <= 180000) return 7; // 3m
        if (delayMillis <= 240000) return 8; // 4m
        if (delayMillis <= 300000) return 9; // 5m
        if (delayMillis <= 360000) return 10; // 6m
        if (delayMillis <= 420000) return 11; // 7m
        if (delayMillis <= 480000) return 12; // 8m
        if (delayMillis <= 540000) return 13; // 9m
        if (delayMillis <= 600000) return 14; // 10m
        if (delayMillis <= 1200000) return 15; // 20m
        if (delayMillis <= 1800000) return 16; // 30m
        if (delayMillis <= 3600000) return 17; // 1h
        return 18; // 2h
    }
}

/**
 * å®šæ—¶å‘å¸ƒæ¶ˆè´¹è€…
 */
@Component
@RocketMQMessageListener(
    topic = "article-schedule-publish-topic",
    consumerGroup = "article-schedule-consumer-group"
)
public class ArticleScheduleConsumer implements RocketMQListener<ArticleScheduleMessage> {

    @Autowired
    private ArticleService articleService;

    @Override
    public void onMessage(ArticleScheduleMessage message) {
        // æ£€æŸ¥æ˜¯å¦åˆ°è¾¾å‘å¸ƒæ—¶é—´
        if (LocalDateTime.now().isAfter(message.getPublishTime())) {
            articleService.publishArticleNow(message.getArticleId());
        }
    }
}
```

---

## 6. æœç´¢æœåŠ¡ä¼˜åŒ–

### 6.1 Elasticsearché›†ç¾¤éƒ¨ç½²

```yaml
# elasticsearch.yml
cluster.name: blog-es-cluster
node.name: es-node-1
network.host: 0.0.0.0
http.port: 9200
transport.port: 9300

# é›†ç¾¤é…ç½®
discovery.seed_hosts: ["192.168.1.100", "192.168.1.101", "192.168.1.102"]
cluster.initial_master_nodes: ["es-node-1", "es-node-2", "es-node-3"]

# åˆ†ç‰‡é…ç½®
index.number_of_shards: 3
index.number_of_replicas: 1

# å†…å­˜é…ç½®
bootstrap.memory_lock: true

# å®‰å…¨é…ç½®
xpack.security.enabled: true
xpack.security.transport.ssl.enabled: true
```

```yaml
# application.yml
spring:
  elasticsearch:
    uris:
      - http://192.168.1.100:9200
      - http://192.168.1.101:9200
      - http://192.168.1.102:9200
    username: elastic
    password: password
    connection-timeout: 3s
    socket-timeout: 30s
```

### 6.2 ç´¢å¼•è®¾è®¡

```java
/**
 * æ–‡ç« æœç´¢æ–‡æ¡£
 */
@Document(indexName = "blog_article", createIndex = true)
@Setting(shards = 3, replicas = 1, refreshInterval = "30s")
public class ArticleDocument {

    @Id
    private Long id;

    @Field(type = FieldType.Text, analyzer = "ik_max_word", searchAnalyzer = "ik_smart")
    private String title;

    @Field(type = FieldType.Text, analyzer = "ik_max_word", searchAnalyzer = "ik_smart")
    private String summary;

    @Field(type = FieldType.Text, analyzer = "ik_max_word")
    private String content;

    @Field(type = FieldType.Keyword)
    private String categoryName;

    @Field(type = FieldType.Keyword)
    private List<String> tags;

    @Field(type = FieldType.Keyword)
    private String authorName;

    @Field(type = FieldType.Keyword)
    private String authorAvatar;

    @Field(type = FieldType.Integer)
    private Integer viewCount;

    @Field(type = FieldType.Integer)
    private Integer commentCount;

    @Field(type = FieldType.Integer)
    private Integer likeCount;

    @Field(type = FieldType.Keyword)
    private String status;

    @Field(type = FieldType.Keyword)
    private String readType;

    @Field(type = FieldType.Date, format = DateFormat.date_hour_minute_second)
    private LocalDateTime createTime;

    @Field(type = FieldType.Double)
    private Double score;  // ç»¼åˆè¯„åˆ†
}
```

### 6.3 æœç´¢æœåŠ¡å®ç°

```java
@Service
public class ArticleSearchService {

    @Autowired
    private ElasticsearchRestTemplate elasticsearchTemplate;

    /**
     * å…¨æ–‡æœç´¢
     */
    public Page<ArticleDocument> search(String keyword, Integer page, Integer size) {
        BoolQueryBuilder query = QueryBuilders.boolQuery();

        // å¤šå­—æ®µæœç´¢ï¼ˆä¸åŒæƒé‡ï¼‰
        query.should(QueryBuilders.matchQuery("title", keyword).boost(3.0f))
             .should(QueryBuilders.matchQuery("summary", keyword).boost(2.0f))
             .should(QueryBuilders.matchQuery("content", keyword).boost(1.0f))
             .minimumShouldMatch(1);

        // è¿‡æ»¤æ¡ä»¶
        query.filter(QueryBuilders.termQuery("status", "PUBLISHED"));

        // æ’åºï¼šæŒ‰ç›¸å…³åº¦å’Œæ—¶é—´ç»¼åˆæ’åº
        NativeSearchQuery searchQuery = new NativeSearchQueryBuilder()
            .withQuery(query)
            .withPageable(PageRequest.of(page - 1, size))
            .withSorts(
                SortBuilders.fieldSort("score").order(SortOrder.DESC),  // ç»¼åˆè¯„åˆ†
                SortBuilders.fieldSort("createTime").order(SortOrder.DESC)  // æ—¶é—´
            )
            .build();

        SearchHits<ArticleDocument> searchHits = elasticsearchTemplate.search(searchQuery, ArticleDocument.class);

        return new PageImpl<>(
            searchHits.getSearchHits().stream()
                .map(SearchHit::getContent)
                .collect(Collectors.toList()),
            PageRequest.of(page - 1, size),
            searchHits.getTotalHits()
        );
    }

    /**
     * é«˜çº§æœç´¢ï¼ˆå¤šæ¡ä»¶ç­›é€‰ï¼‰
     */
    public Page<ArticleDocument> advancedSearch(SearchRequest request) {
        BoolQueryBuilder query = QueryBuilders.boolQuery();

        // å…³é”®è¯æœç´¢
        if (StringUtils.isNotBlank(request.getKeyword())) {
            query.must(QueryBuilders.multiMatchQuery(request.getKeyword(), "title", "summary", "content"));
        }

        // åˆ†ç±»ç­›é€‰
        if (StringUtils.isNotBlank(request.getCategory())) {
            query.filter(QueryBuilders.termQuery("categoryName", request.getCategory()));
        }

        // æ ‡ç­¾ç­›é€‰
        if (CollectionUtils.isNotEmpty(request.getTags())) {
            query.filter(QueryBuilders.termsQuery("tags", request.getTags()));
        }

        // æ—¶é—´èŒƒå›´
        if (request.getStartTime() != null) {
            query.filter(QueryBuilders.rangeQuery("createTime").gte(request.getStartTime()));
        }
        if (request.getEndTime() != null) {
            query.filter(QueryBuilders.rangeQuery("createTime").lte(request.getEndTime()));
        }

        NativeSearchQuery searchQuery = new NativeSearchQueryBuilder()
            .withQuery(query)
            .withPageable(PageRequest.of(request.getPage() - 1, request.getSize()))
            .build();

        SearchHits<ArticleDocument> searchHits = elasticsearchTemplate.search(searchQuery, ArticleDocument.class);

        return new PageImpl<>(
            searchHits.getSearchHits().stream()
                .map(SearchHit::getContent)
                .collect(Collectors.toList()),
            PageRequest.of(request.getPage() - 1, request.getSize()),
            searchHits.getTotalHits()
        );
    }

    /**
     * èšåˆæœç´¢ï¼ˆæŒ‰åˆ†ç±»åˆ†ç»„ï¼‰
     */
    public Map<String, Long> aggregateByCategory(String keyword) {
        BoolQueryBuilder query = QueryBuilders.boolQuery()
            .must(QueryBuilders.multiMatchQuery(keyword, "title", "summary", "content"))
            .filter(QueryBuilders.termQuery("status", "PUBLISHED"));

        AggregationBuilder aggregation = AggregationBuilders
            .terms("category_agg")
            .field("categoryName")
            .size(20);

        NativeSearchQuery searchQuery = new NativeSearchQueryBuilder()
            .withQuery(query)
            .addAggregation(aggregation)
            .build();

        SearchHits<ArticleDocument> searchHits = elasticsearchTemplate.search(searchQuery, ArticleDocument.class);

        Aggregations aggregations = searchHits.getAggregations();
        Terms terms = aggregations.get("category_agg");

        return terms.getBuckets().stream()
            .collect(Collectors.toMap(
                Terms.Bucket::getKeyAsString,
                Terms.Bucket::getDocCount
            ));
    }

    /**
     * é«˜äº®æ˜¾ç¤º
     */
    public List<ArticleDocument> searchWithHighlight(String keyword, Integer page, Integer size) {
        BoolQueryBuilder query = QueryBuilders.boolQuery()
            .must(QueryBuilders.multiMatchQuery(keyword, "title", "summary", "content"))
            .filter(QueryBuilders.termQuery("status", "PUBLISHED"));

        // é«˜äº®é…ç½®
        HighlightBuilder highlightBuilder = new HighlightBuilder()
            .field("title")
            .field("summary")
            .preTags("<em class='highlight'>")
            .postTags("</em>")
            .fragmentSize(150)
            .numOfFragments(3);

        NativeSearchQuery searchQuery = new NativeSearchQueryBuilder()
            .withQuery(query)
            .withHighlightBuilder(highlightBuilder)
            .withPageable(PageRequest.of(page - 1, size))
            .build();

        SearchHits<ArticleDocument> searchHits = elasticsearchTemplate.search(searchQuery, ArticleDocument.class);

        return searchHits.getSearchHits().stream()
            .map(hit -> {
                ArticleDocument doc = hit.getContent();

                // è®¾ç½®é«˜äº®å†…å®¹
                Map<String, List<String>> highlightFields = hit.getHighlightFields();
                if (highlightFields.containsKey("title")) {
                    doc.setTitle(highlightFields.get("title").get(0));
                }
                if (highlightFields.containsKey("summary")) {
                    doc.setSummary(highlightFields.get("summary").get(0));
                }

                return doc;
            })
            .collect(Collectors.toList());
    }
}
```

### 6.4 æœç´¢å»ºè®®

```java
@Service
public class SearchSuggestionService {

    @Autowired
    private ElasticsearchRestTemplate elasticsearchTemplate;

    /**
     * æœç´¢å»ºè®®ï¼ˆè‡ªåŠ¨è¡¥å…¨ï¼‰
     */
    public List<String> suggest(String prefix, int size) {
        CompletionSuggestionBuilder suggestionBuilder = SuggestBuilders
            .completionSuggestion("title.suggest")
            .prefix(prefix)
            .size(size);

        SuggestBuilder suggestBuilder = new SuggestBuilder()
            .addSuggestion("article_suggest", suggestionBuilder);

        NativeSearchQuery searchQuery = new NativeSearchQueryBuilder()
            .withSuggestBuilder(suggestBuilder)
            .build();

        SearchHits<ArticleDocument> searchHits = elasticsearchTemplate.search(searchQuery, ArticleDocument.class);

        return searchHits.getSuggest().getSuggestion("article_suggest").getEntries()
            .stream()
            .flatMap(entry -> entry.getOptions().stream())
            .map(option -> option.getText().string())
            .limit(size)
            .collect(Collectors.toList());
    }

    /**
     * ç›¸å…³æœç´¢æ¨è
     */
    public List<String> getRelatedSearches(String keyword) {
        // åŸºäºæœç´¢å†å²æ¨è
        String key = "search:related:" + keyword;
        String cached = redisService.get(key);

        if (cached != null) {
            return JsonUtil.fromJson(cached, new TypeReference<List<String>>() {});
        }

        // åŸºäºESèšåˆæ¨è
        // ...
        return Collections.emptyList();
    }
}
```

---

## 7. æœåŠ¡æ²»ç†ä¼˜åŒ–

### 7.1 é™æµé…ç½®

```yaml
spring:
  cloud:
    sentinel:
      transport:
        dashboard: 192.168.1.100:8858
      eager: true
      datasource:
        flow:
          nacos:
            server-addr: 192.168.1.100:8848
            dataId: blog-sentinel-flow
            groupId: DEFAULT_GROUP
            rule-type: flow
```

```java
/**
 * é™æµæ³¨è§£
 */
@Target({ElementType.METHOD, ElementType.TYPE})
@Retention(RetentionPolicy.RUNTIME)
@Documented
public @interface RateLimit {
    /**
     * èµ„æºå
     */
    String value() default "";

    /**
     * æ¯ç§’é™åˆ¶è¯·æ±‚æ•°
     */
    int permitsPerSecond() default 100;

    /**
     * è¶…æ—¶æ—¶é—´
     */
    int timeout() default 1;
}

/**
 * é™æµåˆ‡é¢
 */
@Aspect
@Component
public class RateLimitAspect {

    @Around("@annotation(rateLimit)")
    public Object around(ProceedingJoinPoint point, RateLimit rateLimit) throws Throwable {
        String resource = rateLimit.value();
        if (StringUtils.isEmpty(resource)) {
            resource = point.getSignature().toString();
        }

        Entry entry = null;
        try {
            entry = SphU.entry(resource);
            return point.proceed();
        } catch (BlockException e) {
            throw new RateLimitExceededException("è®¿é—®è¿‡äºé¢‘ç¹ï¼Œè¯·ç¨åå†è¯•");
        } finally {
            if (entry != null) {
                entry.exit();
            }
        }
    }
}
```

### 7.2 ç†”æ–­é™çº§

```java
/**
 * æ–‡ç« æœåŠ¡ï¼ˆå¸¦ç†”æ–­é™çº§ï¼‰
 */
@Service
public class ArticleService {

    /**
     * è·å–æ–‡ç« è¯¦æƒ…ï¼ˆå¸¦ç†”æ–­ï¼‰
     */
    @SentinelResource(
        value = "getArticleDetail",
        blockHandler = "getArticleDetailBlockHandler",
        fallback = "getArticleDetailFallback"
    )
    public ArticleDetailVO getArticleDetail(Long id) {
        Article article = articleMapper.selectById(id);
        if (article == null) {
            throw new BusinessException("æ–‡ç« ä¸å­˜åœ¨");
        }
        return convertToVO(article);
    }

    /**
     * é™æµ/ç†”æ–­å¤„ç†
     */
    public ArticleDetailVO getArticleDetailBlockHandler(Long id, BlockException ex) {
        log.warn("æ–‡ç« è¯¦æƒ…æŸ¥è¯¢è¢«é™æµ: id={}", id);
        return getDegradedArticle(id);
    }

    /**
     * é™çº§å¤„ç†
     */
    public ArticleDetailVO getArticleDetailFallback(Long id, Throwable ex) {
        log.error("æ–‡ç« è¯¦æƒ…æŸ¥è¯¢å¼‚å¸¸: id={}", id, ex);
        return getDegradedArticle(id);
    }

    private ArticleDetailVO getDegradedArticle(Long id) {
        // è¿”å›ç¼“å­˜æ•°æ®æˆ–é»˜è®¤æ•°æ®
        return ArticleDetailVO.builder()
            .id(id)
            .title("æ–‡ç« åŠ è½½ä¸­...")
            .build();
    }
}
```

### 7.3 çº¿ç¨‹æ± éš”ç¦»

```java
@Configuration
public class ThreadPoolConfig {

    @Bean("articleQueryExecutor")
    public ThreadPoolExecutor articleQueryExecutor() {
        return new ThreadPoolExecutor(
            10, 50, 60L, TimeUnit.SECONDS,
            new LinkedBlockingQueue<>(1000),
            new ThreadFactoryBuilder().setNameFormat("article-query-%d").build(),
            new ThreadPoolExecutor.CallerRunsPolicy()
        );
    }

    @Bean("esSearchExecutor")
    public ThreadPoolExecutor esSearchExecutor() {
        return new ThreadPoolExecutor(
            20, 100, 60L, TimeUnit.SECONDS,
            new LinkedBlockingQueue<>(2000),
            new ThreadFactoryBuilder().setNameFormat("es-search-%d").build(),
            new ThreadPoolExecutor.CallerRunsPolicy()
        );
    }
}
```

---

## 8. æ¥å£æ€§èƒ½ä¼˜åŒ–

### 8.1 æ‰¹é‡æ¥å£ä¼˜åŒ–

```java
@RestController
@RequestMapping("/api/article")
public class ArticleController {

    @PostMapping("/batch")
    public Result<Map<Long, ArticleVO>> getArticlesBatch(@RequestBody List<Long> ids) {
        if (CollectionUtils.isEmpty(ids) || ids.size() > 100) {
            return Result.error("æ‰¹é‡æŸ¥è¯¢æ•°é‡ä¸èƒ½è¶…è¿‡100");
        }

        Map<Long, ArticleVO> result = articleService.getArticlesBatch(ids);
        return Result.success(result);
    }
}
```

### 8.2 æ¥å£åˆå¹¶

```java
@RestController
@RequestMapping("/api/home")
public class HomeController {

    @GetMapping("/data")
    public Result<HomeDataVO> getHomeData() {
        // å¼‚æ­¥å¹¶è¡ŒæŸ¥è¯¢
        CompletableFuture<List<Article>> hotArticlesFuture = CompletableFuture.supplyAsync(
            () -> articleService.getHotArticles(10)
        );

        CompletableFuture<List<Article>> latestArticlesFuture = CompletableFuture.supplyAsync(
            () -> articleService.getLatestArticles(10)
        );

        CompletableFuture<List<Category>> categoriesFuture = CompletableFuture.supplyAsync(
            () -> categoryService.list()
        );

        CompletableFuture.allOf(hotArticlesFuture, latestArticlesFuture, categoriesFuture).join();

        HomeDataVO homeData = HomeDataVO.builder()
            .hotArticles(convertToVO(hotArticlesFuture.join()))
            .latestArticles(convertToVO(latestArticlesFuture.join()))
            .categories(categoriesFuture.join())
            .build();

        return Result.success(homeData);
    }
}
```

---

## 9. æ–‡ä»¶å­˜å‚¨ä¼˜åŒ–

### 9.1 å¯¹è±¡å­˜å‚¨é›†æˆ

```java
@Service
public class OssService {

    @Autowired
    private OSS ossClient;

    public String uploadFile(MultipartFile file, String folder) {
        String originalFilename = file.getOriginalFilename();
        String extension = originalFilename.substring(originalFilename.lastIndexOf("."));
        String filename = folder + "/" + IdUtil.simpleUUID() + extension;

        ossClient.putObject("blog-bucket", filename, file.getInputStream());
        return "https://cdn.example.com/" + filename;
    }
}
```

---

## 10. ç›‘æ§ä¸è¿ç»´

### 10.1 Prometheusç›‘æ§

```yaml
# application.yml
management:
  endpoints:
    web:
      exposure:
        include: "prometheus,health,info"
  metrics:
    tags:
      application: ${spring.application.name}
```

### 10.2 é“¾è·¯è¿½è¸ª

```xml
<dependency>
    <groupId>org.apache.skywalking</groupId>
    <artifactId>apm-toolkit-trace</artifactId>
    <version>8.16.0</version>
</dependency>
```

---

## 11. å®‰å…¨ä¼˜åŒ–

### 11.1 é˜²åˆ·æœºåˆ¶

```java
@Target({ElementType.METHOD})
@Retention(RetentionPolicy.RUNTIME)
public @interface AntiBrush {
    int time() default 60;
    int count() default 10;
    LimitType limitType() default LimitType.IP;
}
```

### 11.2 æ•æ„Ÿè¯è¿‡æ»¤

```java
@Service
public class SensitiveWordService {
    public boolean containsSensitiveWord(String text);
    public String filterSensitiveWord(String text);
}
```

---

## 12. å®æ–½è·¯çº¿å›¾

### 12.1 ç¬¬ä¸€é˜¶æ®µï¼ˆ1-2ä¸ªæœˆï¼‰

| ä¼˜å…ˆçº§ | ä¼˜åŒ–é¡¹ | é¢„æœŸæ•ˆæœ |
|--------|--------|----------|
| P0 | æ•°æ®åº“ç´¢å¼•ä¼˜åŒ– | æŸ¥è¯¢æ€§èƒ½æå‡50%+ |
| P0 | Redisç¼“å­˜å®Œå–„ | å“åº”æ—¶é—´é™ä½70% |
| P0 | æ¥å£é™æµé™çº§ | ç³»ç»Ÿç¨³å®šæ€§æå‡ |
| P0 | N+1æŸ¥è¯¢ä¼˜åŒ– | æ•°æ®åº“è´Ÿè½½é™ä½60% |

### 12.2 ç¬¬äºŒé˜¶æ®µï¼ˆ3-6ä¸ªæœˆï¼‰

| ä¼˜å…ˆçº§ | ä¼˜åŒ–é¡¹ | é¢„æœŸæ•ˆæœ |
|--------|--------|----------|
| P0 | è¯»å†™åˆ†ç¦» | è¯»QPSæå‡3å€ |
| P0 | æ¶ˆæ¯é˜Ÿåˆ—å¼‚æ­¥åŒ– | å†™å…¥æ€§èƒ½æå‡5å€ |
| P0 | Elasticsearchæœç´¢ | æœç´¢æ€§èƒ½æå‡10å€ |
| P0 | åˆ†åº“åˆ†è¡¨ | æ”¯æ’‘åƒä¸‡çº§æ•°æ® |

### 12.3 ç¬¬ä¸‰é˜¶æ®µï¼ˆ6-12ä¸ªæœˆï¼‰

| ä¼˜å…ˆçº§ | ä¼˜åŒ–é¡¹ | é¢„æœŸæ•ˆæœ |
|--------|--------|----------|
| P0 | å®¹å™¨åŒ–éƒ¨ç½²ï¼ˆK8sï¼‰ | å¼¹æ€§ä¼¸ç¼© |
| P1 | æœåŠ¡ç½‘æ ¼ï¼ˆIstioï¼‰ | æœåŠ¡æ²»ç†å¢å¼º |
| P1 | å¤šçº§ç¼“å­˜å®Œå–„ | ç¼“å­˜å‘½ä¸­ç‡95%+ |
| P1 | CDNåŠ é€Ÿ | é™æ€èµ„æºåŠ è½½æé€Ÿ |

---

## æ€»ç»“

æœ¬æ–¹æ¡ˆä»æ•°æ®åº“ã€ç¼“å­˜ã€æ¶ˆæ¯é˜Ÿåˆ—ã€æœç´¢ã€æœåŠ¡æ²»ç†ç­‰å¤šä¸ªç»´åº¦æä¾›äº†å…¨é¢çš„ä¼˜åŒ–å»ºè®®ï¼Œç›®æ ‡æ˜¯ä½¿ç³»ç»Ÿèƒ½å¤Ÿæ”¯æ’‘ï¼š

- **åƒä¸‡çº§æ–‡ç« æ•°æ®**
- **QPSä»ç™¾çº§æå‡åˆ°ä¸‡çº§**
- **å“åº”æ—¶é—´ä»ç§’çº§é™ä½åˆ°æ¯«ç§’çº§**
- **ç³»ç»Ÿå¯ç”¨æ€§è¾¾åˆ°99.9%ä»¥ä¸Š**

---

*æ–‡æ¡£ç‰ˆæœ¬: v1.0*
*åˆ›å»ºæ—¶é—´: 2025-01-11*
